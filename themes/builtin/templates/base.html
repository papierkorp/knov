<!DOCTYPE html>
<html>
<head>
    <title>{{.Title}}</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="/themes/{{.ThemeName}}/static/css/base.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/style.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/fileview.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/fileedit.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/dashboard.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/search.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/overview.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/playground.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/browsefiles.css" rel="stylesheet"/>
    <link href="/themes/{{.ThemeName}}/static/css/codehighlight.css" rel="stylesheet"/>
    <link href="/static/css/custom.css" rel="stylesheet"/>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"/>
    <link rel="stylesheet" href="/static/toastui-editor-3.2.2.min.css"/>
</head>
<body
    data-theme="{{.ThemeName}}"
    data-dark-mode="{{.DarkMode}}"
    data-color-scheme="{{.ColorScheme}}"
    data-language="{{.Language}}"
>
    <div id="app-wrapper">
        {{template "header" .}}
        <main id="app-main">
            {{template "content" .}}
        </main>
    </div>
    <div class="htmx-indicator" id="app-loading">
        <div class="loading-spinner"></div>
    </div>
    <script src="/static/htmx.min.js"></script>
    <script src="/static/toastui-editor-3.2.2.min.js"></script>
    <script>
        // Global HTMX configuration
        document.body.addEventListener('htmx:configRequest', (event) => {
            // Add custom headers for HTMX requests
            event.detail.headers['X-Requested-With'] = 'HTMX';
        });

        // Update page title on navigation
        document.body.addEventListener('htmx:afterSwap', (event) => {
            const title = event.detail.target.getAttribute('data-page-title');
            if (title) {
                document.title = title;
            }
        });

        // Handle navigation indicator - show/hide loading bar
        const loadingIndicator = document.getElementById('app-loading');

        // Show indicator when request starts
        document.body.addEventListener('htmx:beforeRequest', (event) => {
            loadingIndicator.classList.add('active');
        });

        // Hide indicator when complete (multiple events to ensure it's hidden)
        const hideLoading = () => {
            loadingIndicator.classList.remove('active');
        };

        document.body.addEventListener('htmx:afterSwap', hideLoading);
        document.body.addEventListener('htmx:afterSettle', hideLoading);
        document.body.addEventListener('htmx:afterOnLoad', hideLoading);
        document.body.addEventListener('htmx:responseError', hideLoading);
        document.body.addEventListener('htmx:sendError', hideLoading);
        document.body.addEventListener('htmx:timeout', hideLoading);
    </script>
</body>
</html>

{{define "header"}}
<header id="component-header">
    <div class="header-left">
        <a class="logo" href="/">K</a>
        <div class="search-container">
            <input
                placeholder="{{T "Search.."}}"
                hx-get="/api/search"
                hx-target="#search-results"
                hx-trigger="keyup changed delay:300ms"
                hx-swap="innerHTML"
                name="q"
                id="search-input"
            />
            <div class="search-dropdown">
                <div id="search-results">
                    <div class="component-search-hint">start typing to search...</div>
                </div>
            </div>
        </div>
    </div>
    <div class="header-mid" hx-get="/api/dashboards" hx-trigger="load">
        <a>Loading...</a>
    </div>
    <div class="header-right">
        <span class="span-header-git-operations">
            <a href="/overview"
               hx-get="/overview"
               hx-target="#app-main"
               hx-push-url="true"
               hx-swap="innerHTML swap:0.2s"
               class="htmx-nav">{{T "Overview"}}</a>
            <a href="/latest-changes"
               hx-get="/latest-changes"
               hx-target="#app-main"
               hx-push-url="true"
               hx-swap="innerHTML swap:0.2s"
               class="htmx-nav">{{T "Latest Changes"}}</a>
            <a href="/history"
               hx-get="/history"
               hx-target="#app-main"
               hx-push-url="true"
               hx-swap="innerHTML swap:0.2s"
               class="htmx-nav">{{T "History"}}</a>
        </span>
        <div class="dropdown-navbar">
            <button class="btn-add">+</button>
            <div class="dropdown-navbar-content">
                <a href="/dashboard/new"
                   hx-get="/dashboard/new"
                   hx-target="#app-main"
                   hx-push-url="true"
                   hx-swap="innerHTML swap:0.2s"
                   class="htmx-nav">{{T "New Dashboard"}}</a>
                <a href="#" onclick="alert('Add Note - Coming Soon')">Add Note</a>
                <a href="#" onclick="alert('Add Todo - Coming Soon')">Add Todo</a>
            </div>
        </div>
        <div class="dropdown-navbar" id="edit-dropdown">
            <button class="btn-edit">
                <i class="fa fa-pen-to-square"></i>
            </button>
            <div class="dropdown-navbar-content" id="edit-dropdown-content">
                <a href="#" id="edit-link">{{T "Edit"}}</a>
                <a href="#" onclick="document.getElementById('rename-modal').style.display='flex'">
                    {{T "Rename"}}
                </a>
                <a href="#" onclick="document.getElementById('delete-modal').style.display='flex'">
                    {{T "Delete"}}
                </a>
            </div>
        </div>
        <div class="dropdown-navbar">
            <button class="btn-menu-dropdown">
                <i class="fa fa-bars" aria-hidden="true"></i>
            </button>
            <div class="dropdown-navbar-content">
                <a href="/"
                   hx-get="/"
                   hx-target="#app-main"
                   hx-push-url="true"
                   hx-swap="innerHTML swap:0.2s"
                   class="htmx-nav">{{T "Home"}}</a>
                <a href="/help"
                   hx-get="/help"
                   hx-target="#app-main"
                   hx-push-url="true"
                   hx-swap="innerHTML swap:0.2s"
                   class="htmx-nav">{{T "Help"}}</a>
                <a href="/playground"
                   hx-get="/playground"
                   hx-target="#app-main"
                   hx-push-url="true"
                   hx-swap="innerHTML swap:0.2s"
                   class="htmx-nav">{{T "Playground"}}</a>
                <a href="/settings"
                   hx-get="/settings"
                   hx-target="#app-main"
                   hx-push-url="true"
                   hx-swap="innerHTML swap:0.2s"
                   class="htmx-nav">{{T "Settings"}}</a>
                <a href="/admin"
                   hx-get="/admin"
                   hx-target="#app-main"
                   hx-push-url="true"
                   hx-swap="innerHTML swap:0.2s"
                   class="htmx-nav">{{T "Admin"}}</a>
                <a href="/swagger/">Swagger</a>
            </div>
        </div>
    </div>
</header>
{{template "edit" .}}
{{end}}

{{define "edit"}}
<div id="rename-modal" class="modal">
    <div class="modal-content">
        <h3>{{T "Rename"}}</h3>
        <form id="rename-form" hx-post="" hx-target="#rename-result">
            <input type="text" name="name" id="rename-input" required/>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">{{T "Rename"}}</button>
                <button
                    type="button"
                    class="btn-secondary"
                    onclick="document.getElementById('rename-modal').style.display='none'"
                >
                    {{T "Cancel"}}
                </button>
            </div>
        </form>
        <div id="rename-result"></div>
    </div>
</div>
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <h3>{{T "Delete"}}</h3>
        <p>{{T "Are you sure?"}}</p>
        <form id="delete-form" hx-delete="" hx-target="#delete-result">
            <div class="modal-actions">
                <button type="submit" class="btn-danger">{{T "Delete"}}</button>
                <button
                    type="button"
                    class="btn-secondary"
                    onclick="document.getElementById('delete-modal').style.display='none'"
                >
                    {{T "Cancel"}}
                </button>
            </div>
        </form>
        <div id="delete-result"></div>
    </div>
</div>
<script>
const path = window.location.pathname;

// Handle dashboard edit
const dashMatch = path.match(/\/dashboard\/([^\/]+)/);
if (dashMatch) {
    const id = dashMatch[1];
    document.getElementById('edit-link').href = `/dashboard/edit/${id}`;
    document.getElementById('rename-form').setAttribute('hx-post', `/api/dashboards/${id}/rename`);
    document.getElementById('delete-form').setAttribute('hx-delete', `/api/dashboards/${id}`);
}

// Handle file edit
const fileMatch = path.match(/\/files\/(.+)/);
if (fileMatch && !path.includes('/edit/')) {
    const filepath = fileMatch[1];
    document.getElementById('edit-link').href = `/files/edit/${filepath}`;
    document.getElementById('edit-dropdown').style.display = 'block';
}
</script>
{{end}}
