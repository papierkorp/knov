<!DOCTYPE html>
<html>
<head>
    <title>{{ .Title }}</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="/themes/{{.CurrentTheme}}/style.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"/>
    <link rel="stylesheet" href="/static/toastui-editor-3.2.2.min.css"/>
</head>
<body
    data-theme="{{ .CurrentTheme }}"
    data-dark-mode="{{ .DarkMode }}"
    data-color-scheme="{{ .ColorScheme }}"
    data-language="{{ .Language }}">
    <div id="wrapper">
        {{ template "header" . }}
        <main>
            {{ template "content" . }}
        </main>
    </div>
    <script src="/static/htmx.min.js"></script>
    <script src="/static/toastui-editor-3.2.2.min.js"></script>
</body>
</html>

{{ define "header" }}
<header id="component-header">
    <div class="header-left">
        <a class="logo" href="/">K</a>
        <div class="search-container">
            <input
                placeholder="Search.."
                hx-get="/api/search"
                hx-target="#search-results"
                hx-trigger="keyup changed delay:300ms"
                hx-swap="innerHTML"
                name="q"
                id="search-input"
            />
            <div class="search-dropdown">
                <div id="search-results">
                    <div class="component-search-hint">start typing to search...</div>
                </div>
            </div>
        </div>
    </div>
    <div class="header-mid" hx-get="/api/dashboards" hx-trigger="load">
        <a>Loading...</a>
    </div>
    <div class="header-right">
        <span class="span-header-git-operations">
            <a href="/overview">Overview</a>
            <a href="/latest-changes">Latest Changes</a>
            <a href="/history">History</a>
        </span>
        <div class="dropdown-navbar">
            <button class="btn-add">+</button>
            <div class="dropdown-navbar-content">
                <a href="/dashboard/new">New Dashboard</a>
                <a href="#" onclick="alert('Add Note - Coming Soon')">Add Note</a>
                <a href="#" onclick="alert('Add Todo - Coming Soon')">Add Todo</a>
            </div>
        </div>
        <div class="dropdown-navbar" id="edit-dropdown">
            <button class="btn-edit">
                <i class="fa fa-pen-to-square"></i>
            </button>
            <div class="dropdown-navbar-content" id="edit-dropdown-content">
                <a href="#" id="edit-link">Edit</a>
                <a href="#" onclick="document.getElementById('rename-modal').style.display='flex'">
                    Rename
                </a>
                <a href="#" onclick="document.getElementById('delete-modal').style.display='flex'">
                    Delete
                </a>
            </div>
        </div>
        <div class="dropdown-navbar">
            <button class="btn-menu-dropdown">
                <i class="fa fa-bars" aria-hidden="true"></i>
            </button>
            <div class="dropdown-navbar-content">
                <a href="/">Home</a>
                <a href="/help">Help</a>
                <a href="/playground">Playground</a>
                <a href="/settings">Settings</a>
                <a href="/admin">Admin</a>
                <a href="/swagger/">Swagger</a>
            </div>
        </div>
    </div>
</header>
{{ template "edit" . }}
{{ end }}

{{ define "edit" }}
<div id="rename-modal" class="modal">
    <div class="modal-content">
        <h3>Rename</h3>
        <form id="rename-form" hx-post="" hx-target="#rename-result">
            <input type="text" name="name" id="rename-input" required/>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">Rename</button>
                <button
                    type="button"
                    class="btn-secondary"
                    onclick="document.getElementById('rename-modal').style.display='none'">
                    Cancel
                </button>
            </div>
        </form>
        <div id="rename-result"></div>
    </div>
</div>
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <h3>Delete</h3>
        <p>Are you sure?</p>
        <form id="delete-form" hx-delete="" hx-target="#delete-result">
            <div class="modal-actions">
                <button type="submit" class="btn-danger">Delete</button>
                <button
                    type="button"
                    class="btn-secondary"
                    onclick="document.getElementById('delete-modal').style.display='none'">
                    Cancel
                </button>
            </div>
        </form>
        <div id="delete-result"></div>
    </div>
</div>
<script>
const path = window.location.pathname;

// Handle dashboard edit
const dashMatch = path.match(/\/dashboard\/([^\/]+)/);
if (dashMatch) {
    const id = dashMatch[1];
    document.getElementById('edit-link').href = `/dashboard/edit/${id}`;
    document.getElementById('rename-form').setAttribute('hx-post', `/api/dashboards/${id}/rename`);
    document.getElementById('delete-form').setAttribute('hx-delete', `/api/dashboards/${id}`);
}

// Handle file edit
const fileMatch = path.match(/\/files\/(.+)/);
if (fileMatch && !path.includes('/edit/')) {
    const filepath = fileMatch[1];
    document.getElementById('edit-link').href = `/files/edit/${filepath}`;
    document.getElementById('edit-dropdown').style.display = 'block';
}
</script>
{{ end }}
