<!DOCTYPE html>
<html>
<head>
    <title>{{ .Title }}</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link href="/themes/{{.CurrentTheme}}/style.css" rel="stylesheet" />
    <link href="/static/css/custom.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico"/>
    <link rel="stylesheet" href="/static/font-awesome-7.0.1-all.min.css"/>
    <link rel="stylesheet" href="/static/toastui-editor-3.2.2.min.css"/>
    <link rel="stylesheet" href="/static/handsontable-16.2.0.full.min.css"/>
    <link rel="stylesheet" href="/static/handsontable-theme-main-16.2.0.min.css"/>
</head>
<body
    data-theme="{{ .CurrentTheme }}"
    data-dark-mode="{{ index .ThemeSettings "darkMode" }}"
    data-color-scheme="{{ index .ThemeSettings "colorScheme" }}"
    data-font-family="{{ index .ThemeSettings "fontFamily" }}"
    data-language="{{ .Language }}">
    <div id="wrapper">
        {{ template "header" . }}
        <main>
            {{ template "content" . }}
        </main>
    </div>
    <script src="/static/htmx.min.js"></script>
    <script src="/static/toastui-editor-3.2.2.min.js"></script>
    <script src="/static/sortable-1.15.0.min.js"></script>
    <script src="/static/handsontable-16.2.0.full.min.js"></script>
</body>
</html>

{{ define "header" }}
<header id="component-header">
    <div class="header-left">
        <a class="logo" href="/">K</a>
        <div class="search-container">
            <input
                placeholder="{{T "Search.."}}"
                hx-get="/api/search"
                hx-target="#search-results"
                hx-trigger="keyup changed delay:300ms"
                hx-swap="innerHTML"
                name="q"
                id="search-input"
            />
            <div class="search-dropdown">
                <div id="search-results">
                    <div class="component-search-hint">{{T "start typing to search..."}}</div>
                </div>
            </div>
        </div>
    </div>
    <div class="header-mid" hx-get="/api/dashboards?short=true" hx-trigger="load">
        <a>{{T "Loading..."}}</a>
    </div>
    <div class="header-right">
        <span class="span-header-git-operations">
            <a href="/overview">{{T "Overview"}}</a>
            <a href="/browse">{{T "Browse"}}</a>
            <a href="/latest-changes">{{T "Latest Changes"}}</a>
        </span>
        <div class="dropdown-navbar">
            <button class="btn-add">+</button>
            <div class="dropdown-navbar-content">
                <a href="/dashboard/new">{{T "Dashboard"}}</a>
                <a href="/files/new/todo">{{T "Todo"}}</a>
                <a href="/files/new/fleeting">{{T "Fleeting"}}</a>
                <a href="/files/new/literature">{{T "Literature"}}</a>
                <a href="/files/new/permanent">{{T "Permanent"}}</a>
                <a href="/files/new/moc">{{T "MOC"}}</a>
                <a href="/files/new/filter">{{T "Filter"}}</a>
                <a href="/files/new/journaling">{{T "Journaling"}}</a>
            </div>
        </div>
        <div class="dropdown-navbar" id="edit-dropdown">
            <button class="btn-edit">
                <i class="fa fa-pen-to-square"></i>
            </button>
            <div class="dropdown-navbar-content" id="edit-dropdown-content">
                <a href="#" id="edit-link">{{T "Edit"}}</a>
                <a href="#" id="history-link">{{T "History"}}</a>
                {{ if eq .FileType "dokuwiki" }}
                <a href="#" id="export-markdown-link">{{T "Export to Markdown"}}</a>
                {{ end }}
                <a href="#" onclick="document.getElementById('rename-modal').style.display='flex'">
                    {{T "Rename"}}
                </a>
                <a href="#" onclick="document.getElementById('delete-modal').style.display='flex'">
                    {{T "Delete"}}
                </a>
            </div>
        </div>
        <div class="dropdown-navbar">
            <button class="btn-menu-dropdown">
                <i class="fa fa-bars" aria-hidden="true"></i>
            </button>
            <div class="dropdown-navbar-content">
                <a href="/">{{T "Home"}}</a>
                <a href="/help">{{T "Help"}}</a>
                <a href="/settings">{{T "Settings"}}</a>
                <a href="/admin">{{T "Admin"}}</a>
            </div>
        </div>
    </div>
</header>
{{ template "edit" . }}
{{ end }}

{{ define "edit" }}
<div id="rename-modal" class="modal">
    <div class="modal-content">
        <h3>{{T "Rename"}}</h3>
        <form id="rename-form" hx-post="" hx-target="#rename-result">
            <input type="text" name="name" id="rename-input" placeholder="Enter new file path (e.g., folder/newname.md)" required/>
            <div class="modal-actions">
                <button type="submit" class="btn-primary">{{T "Rename"}}</button>
                <button
                    type="button"
                    class="btn-secondary"
                    onclick="document.getElementById('rename-modal').style.display='none'">
                    {{T "Cancel"}}
                </button>
            </div>
        </form>
        <div id="rename-result"></div>
    </div>
</div>
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <h3>{{T "Delete"}}</h3>
        <p>{{T "Are you sure?"}}</p>
        <form id="delete-form" hx-delete="" hx-target="#delete-result">
            <div class="modal-actions">
                <button type="submit" class="btn-danger">{{T "Delete"}}</button>
                <button
                    type="button"
                    class="btn-secondary"
                    onclick="document.getElementById('delete-modal').style.display='none'">
                    {{T "Cancel"}}
                </button>
            </div>
        </form>
        <div id="delete-result"></div>
    </div>
</div>
<script>
const path = window.location.pathname;

// Handle dashboard edit
const dashMatch = path.match(/\/dashboard\/([^\/]+)/);
if (dashMatch) {
    const id = dashMatch[1];
    document.getElementById('edit-link').href = `/dashboard/edit/${id}`;
    document.getElementById('rename-form').setAttribute('hx-post', `/api/dashboards/${id}/rename`);
    document.getElementById('delete-form').setAttribute('hx-delete', `/api/dashboards/${id}`);
}

// Handle file edit
const fileMatch = path.match(/\/files\/(.+)/);
if (fileMatch && !path.includes('/edit/')) {
    const filepath = fileMatch[1];
    document.getElementById('edit-link').href = `/files/edit/${filepath}`;
    document.getElementById('history-link').href = `/files/history/${filepath}`;
    document.getElementById('rename-form').setAttribute('hx-post', `/api/files/rename/${filepath}`);
    document.getElementById('delete-form').setAttribute('hx-delete', `/api/files/delete/${filepath}`);
    document.getElementById('rename-input').value = filepath; // populate with full filepath for directory moves
    document.getElementById('edit-dropdown').style.display = 'block';

    {{ if eq .FileType "dokuwiki" }}
    // set export to markdown link for dokuwiki files
    document.getElementById('export-markdown-link').href = `/api/files/export/markdown?filepath=${encodeURIComponent(filepath)}`;
    {{ end }}
}
</script>
{{ end }}
